/*
 MIT
*/
(function(f){f.fn.sortableLists=function(k){function n(b){if(a.isDragged){var p=a.cEl,c=a.doc,g=a.win;b.pageX||A(b);c.scrollTop()>a.rootEl.offset.top-10&&50>b.clientY?a.upScroll?(b.pageY-=e.scroll,f("html, body").each(function(b){f(this).scrollTop(f(this).scrollTop()-e.scroll)}),r(b)):d(b):c.scrollTop()+g.height()<a.rootEl.offset.top+a.rootEl.el.outerHeight(!1)+10&&50>g.height()-b.clientY?a.downScroll?(b.pageY+=e.scroll,f("html, body").each(function(b){f(this).scrollTop(f(this).scrollTop()+e.scroll)}),
r(b)):l(b):w(a);a.oElOld=a.oEl;p.el[0].style.visibility="hidden";a.oEl=oEl=B(b.pageX,b.pageY);p.el[0].style.visibility="visible";C(b,a);D(b,a)}}function m(b){var p=a.cEl,c=f("#sortableListsHint",a.rootEl.el),v=g[0].style,h=null,d=!1,k=f("#sortableListsHintWrapper");"block"==v.display&&c.length&&a.isAllowed?(h=c,d=!0):(h=a.placeholderNode,d=!1);offset=h.offset();p.el.animate({left:offset.left-a.cEl.mL,top:offset.top-a.cEl.mT},250,function(){E(p);h.after(p.el[0]);h[0].style.display="none";v.display=
"none";c.remove();k.removeAttr("id").removeClass(e.hintWrapperClass);k.length&&k.prev("div").append(x.clone(!0));d?a.placeholderNode.slideUp(150,function(){a.placeholderNode.remove();y();e.complete(p.el);a.isDragged=!1}):(a.placeholderNode.remove(),y(),e.complete(p.el),a.isDragged=!1)});w(a);a.doc.unbind("mousemove",n).unbind("mouseup",m)}function d(b){a.upScroll||(a.upScroll=setInterval(function(){a.doc.trigger("mousemove")},50))}function l(b){a.downScroll||(a.downScroll=setInterval(function(){a.doc.trigger("mousemove")},
50))}function r(b){a.pY=b.pageY;a.pX=b.pageX;a.cY=b.clientY;a.cX=b.clientX}function A(b){b.pageY=a.pY;b.pageX=a.pX;b.clientY=a.cY;b.clientX=a.cX}function w(b){clearInterval(b.upScroll);clearInterval(b.downScroll);b.upScroll=b.downScroll=!1}function D(b,a){var c=a.cEl;c.el.css({top:b.pageY-c.xyOffsetDiff.Y-c.mT,left:b.pageX-c.xyOffsetDiff.X-c.mL})}function B(b,e){if(!document.elementFromPoint)return null;var c=a.isRelEFP;if(null===c){var g,h;0<(g=a.doc.scrollTop())&&(c=null==(h=document.elementFromPoint(0,
g+f(window).height()-1))||"HTML"==h.tagName.toUpperCase());0<(g=a.doc.scrollLeft())&&(c=null==(h=document.elementFromPoint(g+f(window).width()-1,0))||"HTML"==h.tagName.toUpperCase())}c&&(b-=a.doc.scrollLeft(),e-=a.doc.scrollTop());c=f(document.elementFromPoint(b,e));if(a.rootEl.el.find(c).length){if(c.is("#sortableListsPlaceholder")||c.is("#sortableListsHint"))return null;if(!c.is("li"))return c=c.closest("li"),c[0]?c:null;if(c.is("li"))return c}else return null}function C(b,p){var c=p.oEl;if(c&&
p.oElOld){var d=c.outerHeight(!1),h=b.pageY-c.offset().top;if(e.insertZonePlus)if(14>h)a:{d=7>h;f("#sortableListsHintWrapper",a.rootEl.el).length&&g.unwrap();if(!d&&b.pageX-c.offset().left>e.insertZone){d=c.children();h=c.children("ul").first();if(h.children().first().is("#sortableListsPlaceholder")){g.css("display","none");break a}h.length?h.prepend(g):(d.first().after(g),g.wrap(t));a.oEl&&q(c)}else{if(c.prev("#sortableListsPlaceholder").length){g.css("display","none");break a}c.before(g)}g.css("display",
"block");a.isAllowed=e.isAllowed(a.cEl.el,f("#sortableListsHint"),c)}else{if(d-14<h)a:{d=d-7<h;f("#sortableListsHintWrapper",a.rootEl.el).length&&g.unwrap();if(!d&&b.pageX-c.offset().left>e.insertZone){d=c.children();h=c.children(e.listSelector).last();if(h.children().last().is("#sortableListsPlaceholder")){g.css("display","none");break a}h.length?d.last().append(g):(c.append(g),g.wrap(t));a.oEl&&q(c)}else{if(c.next("#sortableListsPlaceholder").length){g.css("display","none");break a}c.after(g)}g.css("display",
"block");a.isAllowed=e.isAllowed(a.cEl.el,f("#sortableListsHint"),c)}}else if(5>h)a:{f("#sortableListsHintWrapper",a.rootEl.el).length&&g.unwrap();if(b.pageX-c.offset().left<e.insertZone){if(c.prev("#sortableListsPlaceholder").length){g.css("display","none");break a}c.before(g)}else{d=c.children();h=c.children("ul").first();if(h.children().first().is("#sortableListsPlaceholder")){g.css("display","none");break a}h.length?h.prepend(g):(d.first().after(g),g.wrap(t));a.oEl&&q(c)}g.css("display","block");
a.isAllowed=e.isAllowed(a.cEl.el,f("#sortableListsHint"),c)}else if(d-5<h)a:{f("#sortableListsHintWrapper",a.rootEl.el).length&&g.unwrap();if(b.pageX-c.offset().left<e.insertZone){if(c.next("#sortableListsPlaceholder").length){g.css("display","none");break a}c.after(g)}else{d=c.children();h=c.children(e.listSelector).last();if(h.children().last().is("#sortableListsPlaceholder")){g.css("display","none");break a}h.length?d.last().append(g):(c.append(g),g.wrap(t));a.oEl&&q(c)}g.css("display","block");
a.isAllowed=e.isAllowed(a.cEl.el,f("#sortableListsHint"),c)}}}function q(b){b.removeClass("sortableListsClosed").addClass("sortableListsOpen");b.children("ul, ol").css("display","block");b.children("div").children(".sortableListsOpener").first().css("background-image","url("+e.opener.close+")")}function z(b){b.removeClass("sortableListsOpen").addClass("sortableListsClosed");b.children("ul, ol").css("display","none");b.children("div").children(".sortableListsOpener").first().css("background-image",
"url("+e.opener.open+")")}function E(b){var a=b.el[0].style;b.el.removeClass(e.currElClass+" sortableListsCurrent");a.top="0";a.left="0";a.position="relative";a.width="auto"}function y(){f(e.listSelector,a.rootEl.el).each(function(b){f(this).children().length||(f(this).prev("div").children(".sortableListsOpener").first().remove(),f(this).remove())})}var u=f("body").css("position","relative"),F={currElClass:"",placeholderClass:"",placeholderCss:{position:"relative",padding:0},hintClass:"",hintCss:{display:"none",
position:"relative",padding:0},hintWrapperClass:"",hintWrapperCss:{},baseClass:"",baseCss:{position:"absolute",top:0-parseInt(u.css("margin-top")),left:0-parseInt(u.css("margin-left")),margin:0,padding:0,"z-index":2500},opener:{active:!1,open:"",close:"",openerCss:{"float":"left",display:"inline-block","background-position":"center center","background-repeat":"no-repeat"},openerClass:""},listSelector:"ul",listsClass:"",listsCss:{},insertZone:50,insertZonePlus:!1,scroll:20,ignoreClass:"",isAllowed:function(b,
a){return!0},onDragStart:function(a,e){return!0},complete:function(a){return!0}},e=f.extend(!0,{},F,k),G=f("<"+e.listSelector+" />").prependTo(u).attr("id","sortableListsBase").css(e.baseCss).addClass(e.listsClass+" "+e.baseClass),H=f("<li />").attr("id","sortableListsPlaceholder").css(e.placeholderCss).addClass(e.placeholderClass),g=f("<li />").attr("id","sortableListsHint").css(e.hintCss).addClass(e.hintClass),t=f("<"+e.listSelector+" />").attr("id","sortableListsHintWrapper").addClass(e.listsClass+
" "+e.hintWrapperClass).css(e.listsCss).css(e.hintWrapperCss),x=f("<span />").addClass("sortableListsOpener "+e.opener.openerClass).css("background-image","url("+e.opener.close+")").css(e.opener.openerCss).on("mousedown",function(a){a=f(this).closest("li");a.hasClass("sortableListsClosed")?q(a):z(a);return!1}),a={isDragged:!1,isRelEFP:null,oEl:null,rootEl:null,cEl:null,upScroll:!1,downScroll:!1,pX:0,pY:0,cX:0,cY:0,isAllowed:!0,e:{pageX:0,pageY:0,clientX:0,clientY:0},doc:f(document),win:f(window)};
if(e.opener.active){if(!e.opener.open)throw"Url for opener.open image is not defined";if(!e.opener.close)throw"Url for opener.close image is not defined";f(this).find("li").each(function(){var a=f(this);a.children("ul,ol").length&&(x.clone(!0).prependTo(a.children("div").first()),a.hasClass("sortableListsOpen")||(a.addClass("sortableListsClosed"),z(a)))})}return this.on("mousedown",function(b){var d=f(b.target);if(!(!1!==a.isDragged||e.ignoreClass&&d.hasClass(e.ignoreClass))){b.preventDefault();var d=
d.is("li")?d:d.closest("li"),c=f(this);if(d[0]){e.onDragStart(b,d);a.isDragged=!0;var k=parseInt(d.css("margin-top")),h=parseInt(d.css("margin-bottom")),l=parseInt(d.css("margin-left")),r=parseInt(d.css("margin-right")),q=d.offset(),t=d.innerHeight();a.rootEl={el:c,offset:c.offset(),rootElClass:c.attr("class")};a.cEl={el:d,mT:k,mL:l,mB:h,mR:r,offset:q};a.cEl.xyOffsetDiff={X:b.pageX-a.cEl.offset.left,Y:b.pageY-a.cEl.offset.top};a.cEl.el.addClass("sortableListsCurrent "+e.currElClass);d.before(H);b=
a.placeholderNode=f("#sortableListsPlaceholder");d.css({width:d.width(),position:"absolute",top:q.top-k,left:q.left-l}).prependTo(G);b.css({display:"block",height:t});g.css("height",t);a.doc.on("mousemove",n).on("mouseup",m)}}})};f.fn.sortableListsToArray=function(k,n){k=k||[];var m=0;this.children("li").each(function(){var d=f(this),l={},r=d.attr("id");if(!r)throw console.log(d),"Previous item in console.log has no id. It is necessary to create the array.";l.id=r;l.parentId=n;l.value=d.data("value");
l.order=m;k.push(l);d.children("ul,ol").sortableListsToArray(k,r);m++});return k};f.fn.sortableListsToHierarchy=function(){var k=[],n=0;f(this).children("li").each(function(){var m=f(this),d={},l=m.attr("id");if(!l)throw console.log(m),"Previous item in console.log has no id. It is necessary to create the array.";d.id=l;d.value=m.data("value");d.order=n;k.push(d);d.children=m.children("ul,ol").sortableListsToHierarchy();n++});return k};f.fn.sortableListsToString=function(k,n){k=k||[];n=n||"no-parent";
f(this).children("li").each(function(){var m=f(this),d=m.attr("id"),d=d?d.match(/(.+)[-=_](.+)/):null;if(!d)throw console.log(m),"Previous item in console.log has no id or id is not in required format xx_yy, xx-yy or xx=yy. It is necessary to create valid string.";k.push(d[1]+"["+d[2]+"]="+n);f(this).children("ul,ol").sortableListsToString(k,d[2])});return k.join("&")}})(jQuery);
